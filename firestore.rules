
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isAdmin() {
      return request.auth.token.role == 'Admin' || isSuperAdmin();
    }
    
    function isUser(userId) {
        return request.auth.uid == userId;
    }

    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================================================
    // USER MANAGEMENT
    // ============================================================================
    match /users/{userId} {
      // Admins can manage any user
      // Users can manage their own profile
      allow read, write: if isAdmin() || isUser(userId);
    }
    
    // ============================================================================
    // PARTNER MANAGEMENT
    // ============================================================================
    
    // Admins can read and write all partner data
    match /partners/{partnerId} {
      allow read, write: if isAdmin();
      
      // New users can create a partner profile for themselves during sign up
      allow create: if request.auth != null && request.resource.data.adminIds[0] == request.auth.uid;
    }
    
    // Admins can read and write all business profiles
    match /businessProfiles/{profileId} {
      allow read, write: if isAdmin();
      
      // Allow partner admins to manage their own business profile.
      // Assuming a `partnerId` field exists on the profile that matches a partner doc they have access to.
      allow read, write: if get(/databases/$(database)/documents/partners/$(request.resource.data.partnerId)).data.adminIds[0] == request.auth.uid;
      
       // New users can create a business profile for their new partnership
      allow create: if request.auth != null;
    }

    // ============================================================================
    // WORKFLOWS
    // ============================================================================

    // Admins have full access to global workflow templates
    match /workflowTemplates/{templateId} {
        allow read, write: if isAdmin();
    }
    
    // Partner Admins can read global templates
    match /workflowTemplates/{templateId} {
        allow read: if request.auth.token.role == 'partner_admin';
    }

    // Partners can manage their specific workflow instances
    match /workflowInstances/{instanceId} {
      allow read, write: if get(/databases/$(database)/documents/partners/$(request.resource.data.partnerId)).data.adminIds[0] == request.auth.uid;
    }
    
    // Workers can read workflows they are assigned to. This is more complex and will be flushed out later.
    // match /workflowInstances/{instanceId} {
    //   allow read: if request.auth.token.role == 'worker' && resource.data.assignedWorkerIds.hasAny(request.auth.uid);
    // }

    // ============================================================================
    // PUBLIC / READ-ONLY DATA
    // ============================================================================

    // Any authenticated user can read industry data
    match /industries/{industryId} {
        allow read: if request.auth != null;
        allow write: if isAdmin(); // Only admins can modify industries
    }
  }
}
